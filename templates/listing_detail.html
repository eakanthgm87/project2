{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block content %}

<style>

/* Make page match dashboard/sell/buy style */
body {
    background: linear-gradient(145deg, #e7ffee, #c4fadc);
    font-family: "Poppins", sans-serif;
    overflow-x: hidden;
}

/* -----------------------------
    PREMIUM CONTAINER + CARD
------------------------------*/
.listing-wrapper {
    width: 92%;
    max-width: 1100px;
    margin: 50px auto;
    position: relative;
    z-index: 3;
}

.glass-card {
    background: rgba(255,255,255,0.60);
    backdrop-filter: blur(14px);
    border-radius: 28px;
    padding: 40px;
    box-shadow:
        0 20px 45px rgba(0,0,0,0.20),
        inset 0 2px 3px rgba(255,255,255,0.4);
    animation: fadePop 0.8s ease;
}

/* Hero Title */
.listing-title {
    text-align: center;
    font-size: 42px;
    font-weight: 800;
    color: #064a28;
    letter-spacing: 1px;
    margin-bottom: 24px;
    animation: fadeIn 1s ease;
}

/* -----------------------------
    IMAGE GALLERY
------------------------------*/
.gallery-box {
    text-align: center;
    margin-bottom: 30px;
}

.gallery-box img {
    width: 260px;
    height: 260px;
    object-fit: cover;
    border-radius: 22px;
    margin: 12px;
    box-shadow: 0 8px 22px rgba(0,0,0,0.18);
    transition: 0.25s ease;
}

.gallery-box img:hover {
    transform: scale(1.06);
}

/* -----------------------------
    DETAILS SECTION
------------------------------*/
.details-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 18px;
    margin-top: 25px;
    text-align: center;
}

.detail-item {
    font-size: 18px;
    font-weight: 600;
    color: #064a28;
}

.detail-item span {
    font-weight: 700;
    color: #0b6e4f;
}

/* -----------------------------
    MAP BLOCK
------------------------------*/
#map {
    width: 100%;
    height: 420px;
    border-radius: 22px;
    margin-top: 35px;
    box-shadow: 0 10px 28px rgba(0,0,0,0.18);
    overflow: hidden;

    background: rgba(255,255,255,0.55);
    backdrop-filter: blur(8px);
}

/* -----------------------------
    REQUEST BUTTON
------------------------------*/
.request-btn {
    width: 100%;
    padding: 18px;
    font-size: 20px;
    margin-top: 35px;

    background: linear-gradient(135deg, #2e7d32, #0b5e28);
    border: none;
    color: #fff;
    border-radius: 18px;
    font-weight: 800;

    cursor: pointer;
    transition: 0.25s ease;
    box-shadow: 0 12px 26px rgba(0,0,0,0.20);
}

.request-btn:hover {
    transform: translateY(-4px);
}

.disabled-btn {
    background: gray !important;
    opacity: 0.65;
    cursor: not-allowed;
}

/* -----------------------------
    ANIMATIONS
------------------------------*/
@keyframes fadeIn {
    0% {opacity:0; transform:translateY(20px);}
    100% {opacity:1; transform:translateY(0);}
}

@keyframes fadePop {
    0% {opacity:0; transform:scale(0.95);}
    100% {opacity:1; transform:scale(1);}
}
</style>

<div class="listing-wrapper">
    <div class="glass-card">

        <!-- TITLE -->
        <h2 class="listing-title">{{ listing.crop.name }}</h2>

        <!-- IMAGE GALLERY -->
        <div class="gallery-box">
            {% for img in listing.images.all %}
                <img src="{{ img.image.url }}">
            {% empty %}
                <p style="color:#2f6d42; font-size:16px; font-weight:600;">
                    {% trans "No images uploaded." %}
                </p>
            {% endfor %}
        </div>

        <!-- DETAILS -->
        <div class="details-grid">

            <p class="detail-item">
                <span>{% trans "Price" %}:</span> ₹{{ listing.price_per_unit }}
            </p>

            <p class="detail-item">
                <span>{% trans "Base Price" %}:</span> ₹{{ listing.base_price }}
            </p>

            <p class="detail-item">
                <span>{% trans "Seller" %}:</span> {{ listing.seller.username }}
            </p>

            <p class="detail-item">
                <span>{% trans "Details" %}:</span><br>
                {{ listing.details }}
            </p>

        </div>

        <!-- MAP -->
        <div id="map"></div>

        <!-- BUTTON LOGIC -->
        {% if user.is_authenticated %}

            {% if user == listing.seller %}
                <button class="request-btn disabled-btn" disabled>
                    {% trans "You cannot request your own listing" %}
                </button>

            {% elif already_requested %}
                <button class="request-btn disabled-btn" disabled>
                    {% trans "Request Already Sent" %}
                </button>

            {% else %}
                <form method="post" action="{% url 'send_request' listing.id %}">
                    {% csrf_token %}
                    <button class="request-btn">{% trans "Send Request to Seller" %}</button>
                </form>
            {% endif %}

        {% else %}
            <a href="/login/"><button class="request-btn">{% trans "Login to Send Request" %}</button></a>
        {% endif %}

    </div>
</div>

<!-- MAP SCRIPT -->
<script>
var lat = {{ listing.latitude|default:"null" }};
var lon = {{ listing.longitude|default:"null" }};

if (lat !== null && lon !== null) {

    var view = new ol.View({
        center: ol.proj.fromLonLat([lon, lat]),
        zoom: 12
    });

    var map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({ source: new ol.source.OSM() })
        ],
        view: view
    });

    var marker = new ol.layer.Vector({
        source: new ol.source.Vector({
            features: [new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat([lon, lat])))]
        })
    });

    map.addLayer(marker);

} else {
    document.getElementById("map").innerHTML =
        "<p style='padding:30px; text-align:center; font-size:20px; color:#064a28;'>{% trans 'Location hidden.' %}</p>";
}
</script>

{% endblock %}
