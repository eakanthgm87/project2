{# templates/base.html #}
{% load i18n %}
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>FarmLink Exchange</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
/* =======================================
   GLOBAL SMOOTH TRANSITIONS
   ======================================= */
* { box-sizing: border-box; transition: background .28s ease, color .28s ease, box-shadow .28s ease, transform .12s ease; }

/* =======================================
   THEME TOGGLE BUTTON
   ======================================= */
.theme-toggle {
  position: fixed;
  top: 88px;
  right: 22px;
  z-index: 9999;
  background: rgba(255,255,255,0.72);
  backdrop-filter: blur(8px);
  border: none;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 10px 26px rgba(0,0,0,0.18);
  display: flex;
  align-items: center;
  justify-content: center;
}
.theme-toggle:hover { transform: scale(1.06); }

/* =======================================
   LIGHT & DARK MODE ROOTS
   ======================================= */
body { background: linear-gradient(135deg,#c8f7bf,#9be59d); font-family: "Poppins",sans-serif; margin:0; padding:0; color:#0d3b20; overflow-x:hidden; }
/* ============================================================
   UNIVERSAL DARK MODE ‚Äî FULL SITE THEME FIX
   Works for all pages: dashboard, buy, sell, view listing,
   signup, login, profile, listings, popups, filters, cards, etc.
   ============================================================ */

body.dark-mode {
    background: linear-gradient(145deg,#0b1210,#0e1914) !important;
    color: #e9fcee !important;
}

/* NAVBAR */
body.dark-mode .nav {
    background: rgba(0,0,0,0.55) !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
}
body.dark-mode .nav a {
    color: #d9ffe7 !important;
}

/* PROFILE DROPDOWN */
body.dark-mode .dropdown {
    background: rgba(20,20,20,0.9) !important;
    color: #d9ffe7 !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
}
body.dark-mode .dropdown a {
    color: #c8ffe0 !important;
}

/* LANGUAGE WHEEL */
body.dark-mode #lang-wheel {
    background: rgba(20,20,20,0.85) !important;
    color: #d9ffe7 !important;
}
body.dark-mode .wheel-item {
    background: rgba(40,40,40,0.9) !important;
    color: #d9ffe7 !important;
}
body.dark-mode .wheel-item:hover {
    background: rgba(55,55,55,0.95) !important;
}

/* THEME BUTTON */
body.dark-mode .theme-toggle {
    background: rgba(0,0,0,0.55) !important;
    color: #fff !important;
}

/* GLASS PANELS OF ALL TYPES */
body.dark-mode .glass-card,
body.dark-mode .glass-cover,
body.dark-mode .filters-box,
body.dark-mode .listing-container,
body.dark-mode .listing-wrapper,
body.dark-mode .hero,
body.dark-mode .price-box {
    background: rgba(20,20,20,0.55) !important;
    color: #e9fcee !important;
    backdrop-filter: blur(12px) !important;
}

/* INPUTS, SELECTS, TEXTAREAS */
body.dark-mode input,
body.dark-mode select,
body.dark-mode textarea {
    background: rgba(35,35,35,0.9) !important;
    color: #e9fcee !important;
    border: 1px solid rgba(255,255,255,0.12) !important;
    box-shadow: inset 1px 1px 4px rgba(255,255,255,0.05),
                inset -1px -1px 4px rgba(0,0,0,0.4) !important;
}

/* SEARCH BAR BUTTON */
body.dark-mode .search-button {
    background: linear-gradient(135deg,#0f8a48,#064e27) !important;
    color: white !important;
}

/* LISTING CARDS */
body.dark-mode .card {
    background: rgba(25,25,25,0.72) !important;
    border-color: rgba(255,255,255,0.1) !important;
    color: #d9ffe7 !important;
    box-shadow: 0 10px 28px rgba(0,0,0,0.5) !important;
}
body.dark-mode .card h3,
body.dark-mode .card p,
body.dark-mode .card a {
    color: #c8ffe0 !important;
}
body.dark-mode .card a:hover {
    color: #78ffb4 !important;
}

/* BUTTONS */
body.dark-mode button,
body.dark-mode .request-btn,
body.dark-mode .submit-btn {
    background: linear-gradient(135deg,#1b5e20,#0b3a1d) !important;
    color: white !important;
    border-color: rgba(255,255,255,0.2) !important;
}

/* DISABLED BUTTON */
body.dark-mode .disabled-btn {
    background: rgba(70,70,70,0.5) !important;
}

/* TITLES */
body.dark-mode h1,
body.dark-mode h2,
body.dark-mode h3,
body.dark-mode h4,
body.dark-mode label {
    color: #e9fcee !important;
}

/* MAP AREA */
body.dark-mode #map {
    background: rgba(0,0,0,0.6) !important;
    border: 1px solid rgba(255,255,255,0.12) !important;
}

/* LOGIN + SIGNUP GLASS FORMS */
body.dark-mode .auth-card {
    background: rgba(20,20,20,0.65) !important;
    color: #d9ffe7 !important;
}

/* TABLES (orders, requests etc.) */
body.dark-mode table,
body.dark-mode th,
body.dark-mode td {
    background: rgba(20,20,20,0.65) !important;
    color: #d9ffe7 !important;
    border-color: rgba(255,255,255,0.1) !important;
}

body.dark-mode {
  background: linear-gradient(145deg,#0f1c17,#0d1713) !important;
  color: #e8fff3 !important;
}

/* components that should invert in dark mode */
.dark-mode .glass-card,
.dark-mode .filters-box,
.dark-mode .listing-container,
.dark-mode .listing-wrapper,
.dark-mode .price-box,
.dark-mode .card,
.dark-mode .dropdown {
  background: rgba(20,20,20,0.6) !important;
  color: #d9ffe7 !important;
}
.dark-mode input,
.dark-mode textarea,
.dark-mode select {
  background: rgba(40,40,40,0.92) !important;
  color: #d9ffe7 !important;
  border-color: rgba(255,255,255,0.08) !important;
}

/* =======================================
   NAVBAR
   ======================================= */
.nav {
  width:100%;
  height:70px;
  padding:0 28px;
  position:sticky;
  top:0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  z-index:1000;
  background: rgba(255,255,255,0.45);
  backdrop-filter: blur(12px);
  box-shadow: 0 6px 14px rgba(0,80,30,0.18), inset 2px 2px 5px rgba(255,255,255,0.6);
}
.nav-left a { color: #064e3b; font-size:20px; font-weight:800; text-decoration:none; }
.nav-right { display:flex; gap:22px; align-items:center; flex-wrap:wrap; }
.nav-right a { color:#0d3b20; font-size:15px; font-weight:600; text-decoration:none; padding:6px 10px; border-radius:8px; }
.nav-right a:hover { background: rgba(255,255,255,0.55); }

/* profile area */
.user-profile { position:relative; cursor:pointer; display:flex; align-items:center; gap:10px; }
.user-profile .username { font-weight:700; color:#064e3b; }
.dropdown {
  position:absolute;
  top:56px;
  right:0;
  width:260px;
  padding:14px;
  background: rgba(255,255,255,0.95);
  border-radius:12px;
  display:none;
  flex-direction:column;
  backdrop-filter: blur(8px);
  box-shadow: 0 10px 26px rgba(0,0,0,0.12);
}
.dropdown h4 { margin:4px 0 10px; font-size:16px; color:#064e3b; font-weight:800; }

/* =======================================
   LANGUAGE WHEEL POPUP
   ======================================= */
#lang-wheel-container { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.28); backdrop-filter:blur(4px); z-index:5000; }
#lang-wheel {
  width:360px; max-width:92%;
  margin:100px auto;
  background: rgba(255,255,255,0.60);
  backdrop-filter: blur(16px);
  padding:18px;
  border-radius:18px;
  box-shadow: 0 18px 36px rgba(0,0,0,0.18);
}
.wheel { max-height:260px; overflow:auto; padding-right:6px; }
.wheel-item { padding:12px; margin:8px 0; background:rgba(255,255,255,0.85); border-radius:10px; font-weight:700; cursor:pointer; text-align:center; }
.wheel-item:hover { transform:scale(1.03); background:rgba(255,255,255,0.95); }
.close-wheel { position:absolute; top:8px; right:10px; background:transparent; border:none; font-size:18px; cursor:pointer; }

/* =======================================
   MAIN CONTENT WRAPPER
   ======================================= */
main { width:94%; max-width:1200px; margin:34px auto 80px; position:relative; z-index:2; }

/* small helper for consistent glass panels */
.glass-card { background: rgba(255,255,255,0.6); backdrop-filter: blur(12px); border-radius:18px; padding:18px; box-shadow:0 12px 30px rgba(0,0,0,0.08); }

/* make sure small screens are friendly */
@media (max-width:880px){
  .nav { padding:0 14px; }
  .theme-toggle { top:82px; right:14px; width:46px; height:46px; }
  main { width:96%; margin:24px auto; }
}
</style>

</head>
<body>

<nav class="nav">
  <div class="nav-left">
    <a href="/">FarmLink</a>
  </div>

  <div class="nav-right">
    {% if user.is_authenticated %}
      <a href="/dashboard/">{% trans "Dashboard" %}</a>
      <a href="/buy/">{% trans "Buy" %}</a>
      <a href="/sell/">{% trans "Sell" %}</a>
      <a href="/upcoming/">{% trans "Upcoming" %}</a>
    {% endif %}

    <div class="user-profile" onclick="openLangWheel(event)" title="{% trans 'Change language' %}">
      <a style="cursor:pointer; font-weight:700;">üåê {% trans "Language" %}</a>
    </div>

    {% if user.is_authenticated %}
      <div class="user-profile" onclick="toggleUserDropdown(event)" aria-haspopup="true" aria-expanded="false" title="{% trans 'Account' %}">
        <span class="username">{{ user.username }}</span>
        <div class="dropdown" id="dropdown-menu" role="menu" aria-hidden="true">
          <h4>{{ user.username }}</h4>
          <p style="margin:6px 0;"><b>{% trans "Listings" %}:</b> {{ user.listings.count }}</p>
          <p style="margin:6px 0;"><b>{% trans "Orders" %}:</b> {{ user.orders.count }}</p>
          <a href="{% url 'profile' %}">{% trans "My Profile" %}</a>
          <a href="/logout/">{% trans "Logout" %}</a>
        </div>
      </div>
    {% else %}
      <a href="/login/">{% trans "Login" %}</a>
      <a href="/signup/">{% trans "Signup" %}</a>
    {% endif %}
  </div>
</nav>

<!-- theme toggle -->
<button id="themeToggle" class="theme-toggle" aria-label="{% trans 'Toggle theme' %}">üåô</button>

<!-- LANGUAGE WHEEL POPUP -->
<div id="lang-wheel-container" role="dialog" aria-modal="true">
  <div id="lang-wheel">
    <button class="close-wheel" onclick="closeLangWheel(event)">‚úï</button>
    <h3 style="text-align:center; margin:6px 0 12px;">{% trans "Choose Language" %}</h3>

    <div class="wheel">
      {% get_current_language as LANGUAGE_CODE %}
      {% get_available_languages as LANGS %}
      {% for lang, lang_name in LANGS %}
        <div class="wheel-item" onclick="selectLang('{{ lang }}')">{{ lang_name }}</div>
      {% endfor %}
    </div>

    <form id="langForm" action="{% url 'set_language' %}" method="post" style="display:none;">
      {% csrf_token %}
      <input type="hidden" name="language" id="langInput">
    </form>
  </div>
</div>

<main>
  {% block content %}{% endblock %}
</main>

<script>
/* ---------- Helpers for dropdowns & popups ---------- */
function toggleUserDropdown(e){
  e.stopPropagation();
  const menu = document.getElementById('dropdown-menu');
  if (!menu) return;
  const isOpen = menu.style.display === 'flex';
  // hide any other dropdowns
  document.querySelectorAll('.dropdown').forEach(d=> d.style.display = 'none');
  menu.style.display = isOpen ? 'none' : 'flex';
  menu.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
}

function openLangWheel(e){
  e.stopPropagation();
  const c = document.getElementById('lang-wheel-container');
  if (!c) return;
  c.style.display = 'block';
}

function closeLangWheel(e){
  e && e.stopPropagation();
  const c = document.getElementById('lang-wheel-container');
  if (!c) return;
  c.style.display = 'none';
}

function selectLang(code){
  const input = document.getElementById('langInput');
  const form = document.getElementById('langForm');
  if (input && form) {
    input.value = code;
    form.submit();
  }
}

/* close popups when clicking outside */
document.addEventListener('click', function(evt){
  document.querySelectorAll('.dropdown').forEach(d=> d.style.display='none');
  const cont = document.getElementById('lang-wheel-container');
  const wheel = document.getElementById('lang-wheel');
  if (cont && cont.style.display === 'block' && wheel && !wheel.contains(evt.target)) {
    cont.style.display = 'none';
  }
});

/* ---------- Dark mode toggle with persistence ---------- */
(function initThemeToggle(){
  const btn = document.getElementById('themeToggle');
  if (!btn) return;

  // set initial theme from localStorage
  const saved = localStorage.getItem('theme');
  if (saved === 'dark') {
    document.body.classList.add('dark-mode');
    btn.textContent = '‚òÄÔ∏è';
  } else {
    document.body.classList.remove('dark-mode');
    btn.textContent = 'üåô';
  }

  // toggle handler
  btn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  });
})();

/* ensure keyboard accessibility for escape to close language wheel */
document.addEventListener('keydown', function(e){
  if (e.key === 'Escape') {
    closeLangWheel();
    document.querySelectorAll('.dropdown').forEach(d=> d.style.display='none');
  }
});
</script>

</body>
</html>
